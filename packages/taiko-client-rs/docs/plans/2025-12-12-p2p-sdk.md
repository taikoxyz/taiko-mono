# P2P SDK Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Rebuild `crates/p2p` as a full SDK on top of the refactored `preconfirmation-net` + `preconfirmation-types`, aligned to the latest preconfirmation P2P specification.

**Architecture:** `P2pClient` wraps `preconfirmation_net::P2pNode` + `P2pHandle`, layering SDK storage/dedupe/validation, a catch-up pipeline (head → commitments → txlists), and a typed event API. Network-level validation is provided by `preconfirmation-net` adapters (local or lookahead) and gossipsub scoring is configured in `preconfirmation-net`; SDK adds spec-required invariants (parent linkage, pending buffering, EOP rules, block parameter progression) before surfacing events or storing locally.

**Tech Stack:** Rust 1.88, tokio, futures, thiserror, tracing, metrics, lru or moka, preconfirmation-net, preconfirmation-types.

---

### Task 1: Clear old crate + rewire deps

**Files:**
- Modify: `crates/p2p/Cargo.toml`
- Modify: `crates/p2p/src/lib.rs`
- Delete/Replace: `crates/p2p/src/*`
- Delete/Replace: `crates/p2p/tests/*`

**Step 1: Remove outdated modules**

- Replace existing module files with new skeletons; remove any `preconfirmation-service` usage.

**Step 2: Update Cargo.toml**

- Swap dependencies to:
  - `preconfirmation-net = { path = "../../../preconfirmation-p2p/crates/net" }`
  - `preconfirmation-types = { path = "../../../preconfirmation-p2p/crates/types" }`
  - Keep `tokio`, `futures`, `thiserror`, `tracing`, `metrics`, `serde` (if needed), `lru`/`moka`.

**Step 3: Minimal compile check**

Run: `cargo check -p p2p`
Expected: PASS once stubs compile.

**Step 4: Commit**

```bash
git add crates/p2p/Cargo.toml crates/p2p/src crates/p2p/tests
git commit -m "chore(p2p): clear legacy SDK scaffold"
```

---

### Task 2: SDK config + public types

**Files:**
- Create: `crates/p2p/src/config.rs`
- Create: `crates/p2p/src/types.rs`
- Modify: `crates/p2p/src/lib.rs`

**Step 1: Write failing tests**

Create `crates/p2p/src/types.rs` tests covering enum variants and conversions.

```rust
#[test]
fn sdk_event_covers_gossip_and_reqresp() {
    use crate::types::SdkEvent;
    let _ = SdkEvent::PeerConnected { peer: libp2p::PeerId::random() };
}
```

**Step 2: Run test to verify it fails**

Run: `cargo test -p p2p types::tests::sdk_event_covers_gossip_and_reqresp -v`
Expected: FAIL (module missing).

**Step 3: Implement config + types**

- `P2pClientConfig` embeds `preconfirmation_net::P2pConfig` and SDK-only knobs:
  - `expected_slasher`, `chain_id`, channel sizes, dedupe caps/ttl, catch-up backoff, `max_commitments_per_page`, `max_txlist_bytes`, `enable_metrics`.
- `SdkEvent` covers:
  - `PeerConnected`, `PeerDisconnected`
  - `CommitmentGossip`, `RawTxListGossip`
  - `ReqRespCommitments`, `ReqRespRawTxList`, `ReqRespHead`
  - `HeadSyncStatus`, `Error`
- `SdkCommand` for publish/request helpers (optional).
- Ensure topics/protocol IDs are derived only from `preconfirmation_types` helpers (no legacy topics).

**Step 4: Run tests**

Run: `cargo test -p p2p types::tests::sdk_event_covers_gossip_and_reqresp -v`
Expected: PASS

**Step 5: Commit**

```bash
git add crates/p2p/src/config.rs crates/p2p/src/types.rs crates/p2p/src/lib.rs
git commit -m "feat(p2p): add sdk config and public types"
```

---

### Task 3: Error model

**Files:**
- Create: `crates/p2p/src/error.rs`

**Step 1: Write failing test**

```rust
#[test]
fn error_converts_from_network_error() {
    let err = preconfirmation_net::NetworkError::from("boom");
    let sdk: crate::error::P2pClientError = err.into();
    assert!(matches!(sdk, crate::error::P2pClientError::Network(_)));
}
```

**Step 2: Run test to verify it fails**

Run: `cargo test -p p2p error::tests::error_converts_from_network_error -v`
Expected: FAIL (type missing).

**Step 3: Implement errors**

- `P2pClientError` variants: `Network`, `Validation`, `Storage`, `Timeout`, `Backpressure`,
  `Decode`, `Shutdown`, `MissingData`, `Join`.
- Conversions from `NetworkError`, channel send/recv, and `tokio::time::error::Elapsed`.

**Step 4: Run tests**

Run: `cargo test -p p2p error::tests::error_converts_from_network_error -v`
Expected: PASS

**Step 5: Commit**

```bash
git add crates/p2p/src/error.rs
git commit -m "feat(p2p): add error model"
```

---

### Task 4: Storage + dedupe + pending buffer

**Files:**
- Create: `crates/p2p/src/storage/mod.rs`
- Create: `crates/p2p/src/storage/memory.rs`
- Modify: `crates/p2p/src/lib.rs`

**Step 1: Write failing tests**

```rust
#[test]
fn pending_commitments_release_on_parent() {
    let store = crate::storage::InMemoryStorage::default();
    // add child, then parent, ensure child becomes available
}
```

**Step 2: Run test to verify it fails**

Run: `cargo test -p p2p storage::tests::pending_commitments_release_on_parent -v`
Expected: FAIL

**Step 3: Implement storage**

- `SdkStorage` trait: insert/get commitments/txlists, message-id dedupe, pending children by parent hash.
- `InMemoryStorage` with:
  - ordered commitments by block number
  - txlist map by hash
  - message-id LRU/TTL
  - pending commitments map (parent hash → Vec<commitment>) with TTL expiry
  - dedupe keys for commitments per `(slot, signer)` and `(blockNumber, rawTxListHash)`
- Provide helper to build `MessageId` as hash(topic + payload)

**Step 4: Run tests**

Run: `cargo test -p p2p storage::tests::pending_commitments_release_on_parent -v`
Expected: PASS

**Step 5: Commit**

```bash
git add crates/p2p/src/storage
git commit -m "feat(p2p): add sdk storage and dedupe"
```

---

### Task 5: SDK validation rules (spec §4–§7)

**Files:**
- Create: `crates/p2p/src/validation.rs`

**Step 1: Write failing tests**

```rust
#[test]
fn eop_without_txlist_allows_zero_hash() {
    // validate EOP rules per spec
}
```

**Step 2: Run test to verify it fails**

Run: `cargo test -p p2p validation::tests::eop_without_txlist_allows_zero_hash -v`
Expected: FAIL

**Step 3: Implement SDK validation**

- `ValidationOutcome { status: Valid|Pending|Invalid, penalize, reason }`.
- Use `preconfirmation_types` helpers for:
  - signature verification
  - txlist hash validation
  - parent hash computation
- Additional rules:
  - EOP-only rules (`eop=true`, `raw_tx_list_hash==0x00`)
  - Parent linkage checks; if parent missing → `Pending`
  - Block-number monotonicity checks (if parent known)
  - Block parameter progression checks: `timestamp`, `gas_limit`, `coinbase`, `prover_auth`, `proposal_id` (delegate to chain-specific validator hook if needed)
  - Do not penalize buffered commitments awaiting parents or lookahead schedule

**Step 4: Run tests**

Run: `cargo test -p p2p validation::tests::eop_without_txlist_allows_zero_hash -v`
Expected: PASS

**Step 5: Commit**

```bash
git add crates/p2p/src/validation.rs
git commit -m "feat(p2p): add sdk validation rules"
```

---

### Task 6: Client core + event loop

**Files:**
- Create: `crates/p2p/src/client.rs`
- Modify: `crates/p2p/src/lib.rs`

**Step 1: Write failing tests**

```rust
#[tokio::test]
async fn client_starts_and_emits_started_event() {
    // start client with test config and ensure first event is Started or PeerConnected
}
```

**Step 2: Run test to verify it fails**

Run: `cargo test -p p2p client::tests::client_starts_and_emits_started_event -v`
Expected: FAIL

**Step 3: Implement P2pClient**

- Build `P2pNode` with `LocalValidationAdapter` or `LookaheadValidationAdapter`.
- Spawn `P2pNode::run()`; spawn event loop to process `NetworkEvent` and emit `SdkEvent`.
- Provide async helpers:
  - `publish_commitment`, `publish_raw_txlist`
  - `request_commitments`, `request_raw_txlist`, `request_head`
  - `update_head`, `shutdown`, `subscribe`

**Step 4: Run tests**

Run: `cargo test -p p2p client::tests::client_starts_and_emits_started_event -v`
Expected: PASS

**Step 5: Commit**

```bash
git add crates/p2p/src/client.rs crates/p2p/src/lib.rs
git commit -m "feat(p2p): add client core"
```

---

### Task 7: Catch-up pipeline (spec §6.2, §11–§12)

**Files:**
- Create: `crates/p2p/src/catchup.rs`
- Modify: `crates/p2p/src/client.rs`

**Step 1: Write failing tests**

```rust
#[tokio::test]
async fn catchup_requests_commitments_then_txlists() {
    // stub a handle, ensure request order and backoff state transitions
}
```

**Step 2: Run test to verify it fails**

Run: `cargo test -p p2p catchup::tests::catchup_requests_commitments_then_txlists -v`
Expected: FAIL

**Step 3: Implement catch-up**

- `CatchupState` machine: `Idle`, `Syncing`, `Live`.
- Request head; page commitments (`max_commitments_per_page`); enqueue missing txlists; request txlists by hash.
- Emit `SdkEvent::HeadSyncStatus` transitions.
- Backoff/jitter between retries; cap retries by config.

**Step 4: Run tests**

Run: `cargo test -p p2p catchup::tests::catchup_requests_commitments_then_txlists -v`
Expected: PASS

**Step 5: Commit**

```bash
git add crates/p2p/src/catchup.rs crates/p2p/src/client.rs
git commit -m "feat(p2p): add catch-up pipeline"
```

---

### Task 8: Reorg handling hook (spec §6.3)

**Files:**
- Modify: `crates/p2p/src/client.rs`
- Modify: `crates/p2p/src/types.rs`

**Step 1: Write failing test**

```rust
#[test]
fn reorg_hook_records_anchor_reexec_request() {
    // ensure API surfaces reorg event or callback hook
}
```

**Step 2: Run test to verify it fails**

Run: `cargo test -p p2p reorg::tests::reorg_hook_records_anchor_reexec_request -v`
Expected: FAIL

**Step 3: Implement reorg hook**

- Add an explicit API or callback to signal L1 reorgs affecting `anchor_block_number`.
- Emit a `SdkEvent::Reorg` (or `SdkCommand` to re-execute) for downstream consumers.

**Step 4: Run tests**

Run: `cargo test -p p2p reorg::tests::reorg_hook_records_anchor_reexec_request -v`
Expected: PASS

**Step 5: Commit**

```bash
git add crates/p2p/src/client.rs crates/p2p/src/types.rs
git commit -m "feat(p2p): add reorg hook"
```

---

### Task 9: Handlers + metrics

**Files:**
- Create: `crates/p2p/src/handlers.rs`
- Create: `crates/p2p/src/metrics.rs`

**Step 1: Write failing tests**

```rust
#[test]
fn handler_dedupes_duplicate_commitments() {
    // same message id should not emit event twice
}
```

**Step 2: Run test to verify it fails**

Run: `cargo test -p p2p handlers::tests::handler_dedupes_duplicate_commitments -v`
Expected: FAIL

**Step 3: Implement handlers + metrics**

- Map `NetworkEvent` → `SdkEvent` and apply SDK validation + dedupe.
- Record metrics:
  - gossip received/published, validation outcomes, req/resp latency/outcomes, cache hits, head sync gauges.
- Verify `preconfirmation-net` gossipsub scoring thresholds align with spec §7.1 (document any deviations).

**Step 4: Run tests**

Run: `cargo test -p p2p handlers::tests::handler_dedupes_duplicate_commitments -v`
Expected: PASS

**Step 5: Commit**

```bash
git add crates/p2p/src/handlers.rs crates/p2p/src/metrics.rs
git commit -m "feat(p2p): add handlers and metrics"
```

---

### Task 10: Integration smoke tests

**Files:**
- Create: `crates/p2p/tests/integration_smoke.rs`

**Step 1: Write failing test**

```rust
#[tokio::test]
async fn smoke_client_roundtrip() {
    // simulate gossip/reqresp events and assert storage updates
}
```

**Step 2: Run test to verify it fails**

Run: `cargo test -p p2p --test integration_smoke -v`
Expected: FAIL

**Step 3: Implement test helpers**

- Build synthetic `NetworkEvent` inputs and verify:
  - publish helpers record message IDs
  - dedupe works
  - catch-up statuses emitted

**Step 4: Run tests**

Run: `cargo test -p p2p --test integration_smoke -v`
Expected: PASS

**Step 5: Commit**

```bash
git add crates/p2p/tests/integration_smoke.rs
git commit -m "test(p2p): add integration smoke"
```

---

### Task 11: Docs + crate-level examples

**Files:**
- Modify: `crates/p2p/src/lib.rs`

**Step 1: Write docs**

- Provide quick-start usage and mention spec alignment.

**Step 2: Commit**

```bash
git add crates/p2p/src/lib.rs
git commit -m "docs(p2p): add crate-level usage"
```

---

### Task 12: Verification

**Step 1: Format**

Run: `just fmt`

**Step 2: Lint**

Run: `just clippy`

**Step 3: Tests**

Run: `cargo test -p p2p`

**Step 4: Report blockers**

- Capture any failing commands and document missing data/assumptions.
