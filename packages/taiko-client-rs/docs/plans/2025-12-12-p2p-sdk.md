# P2P SDK Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Build `crates/p2p`, an opinionated SDK around `preconfirmation-p2p` that sidecars use to publish/subscribe preconfirmation gossip, run catch-up (head + commitments + raw txlists), manage storage/dedup/backpressure, expose metrics, and track head after contract sync.

**Architecture:** `P2pSdk` wraps `preconfirmation_p2p_service::P2pService`, layering validation, storage, and orchestration (startup catch-up → live gossip). Modules for config, errors, types/events, storage, resolver, validation, catch-up, handlers, metrics, and tests. No feature flags; defaults mirror Kona/reth presets. Rust async with Tokio, structured tracing, and metrics.

**Tech Stack:** Rust 1.88, tokio, futures, thiserror, tracing, metrics, preconfirmation-p2p (net + service + types), ssf/ssz helpers already in `preconfirmation_types`, optional `lru` for caches.

### Task 1: Workspace wiring & scaffold
**Files:**
- Create: `crates/p2p/Cargo.toml`
- Create: `crates/p2p/src/lib.rs`
- Modify: workspace `Cargo.toml` members

**Steps:**
1. Add `crates/p2p` to `[workspace].members` in root `Cargo.toml`.
2. Write `crates/p2p/Cargo.toml` with deps: `preconfirmation-p2p = { path = "../preconfirmation-p2p/crates/service" }`, `preconfirmation-types = { path = "../preconfirmation-p2p/crates/types" }`, `tokio`, `futures`, `thiserror`, `tracing`, `metrics`, `lru` (or `moka` if already in repo), `serde` (derive), `anyhow` (tests only), `parking_lot` (optional for caches), `uuid`? avoid unless needed.
3. Scaffold `src/lib.rs` exporting modules (`config`, `error`, `types`, `storage`, `resolver`, `validation`, `sdk`, `catchup`, `handlers`, `metrics`, `test_utils`). Run `cargo check -p p2p` (expect PASS once stubs compile).

### Task 2: Config wrapper
**Files:** `crates/p2p/src/config.rs`, update `lib.rs`

**Steps:**
1. Define `P2pSdkConfig` with fields: `network: NetworkConfig`, `chain_id: u64`, channel sizes (cmd/event), cache limits (commitments, txlists), timeouts (req/resp, bootstrap), `max_commitments_per_page`, `enable_metrics`, `gossipsub_validation_soft_fail` flag, `executor_slot_grace` (for submissionWindowEnd drift), `disk_storage` toggle placeholder.
2. Provide `Default` mirroring Kona/reth defaults (mesh, scoring) via `NetworkConfig::default()`; expose builder-style setters.
3. Add helper to derive topic/protocol IDs from `chain_id` using `preconfirmation_types` helpers.

### Task 3: Error model
**Files:** `crates/p2p/src/error.rs`

**Steps:**
1. Create `P2pSdkError` (thiserror) variants: `Validation`, `Network(NetworkError)`, `Storage`, `Timeout`, `Backpressure`, `Decode`, `Shutdown`, `MissingPeer`, `MissingData`, `Join`.
2. Implement conversions from `NetworkError`, `broadcast::error`, `mpsc::error`, `tokio::time::error::Elapsed`.
3. Add `Result<T> = std::result::Result<T, P2pSdkError>` type alias.

### Task 4: Types façade
**Files:** `crates/p2p/src/types.rs`

**Steps:**
1. Re-export `preconfirmation_types::{SignedCommitment, RawTxListGossip, GetCommitmentsByNumberRequest/Response, GetRawTxListRequest/Response, PreconfHead, Preconfirmation, PreconfCommitment, Bytes32, Uint256}`.
2. Define SDK enums/structs: `SdkEvent` (wraps gossip/reqresp/inbound/head sync progress), `SdkCommand` (high-level publish/request intent), `HeadSyncStatus` (Idle/Syncing/Live with heights), `PeerInfo` (peer id + score snapshot).
3. Add lightweight `MessageId` newtype for dedupe keyed by payload hash + topic.

### Task 5: Storage abstraction
**Files:** `crates/p2p/src/storage/mod.rs`, `crates/p2p/src/storage/memory.rs`

**Steps:**
1. Define trait `SdkStorage: Send + Sync` with async fns: `store_commitment`, `get_commitment(hash)`, `store_raw_txlist(hash, blob, anchor)`, `get_raw_txlist(hash)`, `set_head(PreconfHead)`, `head()`, `has_seen_message(id)`, `prune_pending(before_block)`, `pending_children(parent_hash)`.
2. Provide in-memory impl using `parking_lot::RwLock` + `lru::LruCache` to enforce byte caps; expose constructor with limits from config.
3. Add stub trait impl adapter for `preconfirmation_p2p::PreconfStorage` if needed to reuse downstream storage (feature-less now, just types compatible).

### Task 6: Lookahead resolver bridge
**Files:** `crates/p2p/src/resolver.rs`

**Steps:**
1. Define trait alias `Lookahead: preconfirmation_net::LookaheadResolver` and helper to wrap sidecar-provided resolver (URC/lookahead schedule).
2. Provide `NoopLookahead` for tests; document that production passes real resolver from driver.

### Task 7: Validation layer
**Files:** `crates/p2p/src/validation.rs`

**Steps:**
1. Implement `validate_signed_commitment` applying spec §4-§5 (signature over domain, slasher match, submissionWindowEnd, parent linkage, block params, chain id). Accept `Lookahead` handle for slot signer check; allow soft-buffer when schedule missing.
2. Implement `validate_raw_txlist_gossip` per spec §3.4 + size caps; ensure `keccak(txlist) == rawTxListHash` when available; cap bytes.
3. Return `ValidationOutcome { valid, penalize_peer, reason }` to feed scoring; integrate with metrics.

### Task 8: Backpressure & dedupe
**Files:** `crates/p2p/src/sdk.rs` (state section) or `crates/p2p/src/handlers.rs`

**Steps:**
1. Introduce bounded mpsc for commands to driver and bounded broadcast for SDK events; on saturation return `P2pSdkError::Backpressure` and log.
2. Maintain per-topic dedupe cache keyed by `MessageId`; drop self-messages and duplicates; record metrics.

### Task 9: SDK core orchestration
**Files:** `crates/p2p/src/sdk.rs`, update `lib.rs`

**Steps:**
1. Implement `P2pSdk::start(cfg, storage, lookahead)` creating `P2pService::start_with_lookahead_and_storage`; spawn background task piping `NetworkEvent` → internal handler; expose handles for shutdown.
2. Provide async helpers: `publish_commitment`, `publish_raw_txlist`, `request_commitments`, `request_raw_txlist`, `request_head`, `update_head`, `subscribe`, `next_event`, `shutdown`. Map errors to `P2pSdkError` and wrap validation before publish.
3. Expose `run_with_handler` taking a callback/trait to consume `SdkEvent` for sidecar components.

### Task 10: Catch-up pipeline
**Files:** `crates/p2p/src/catchup.rs`

**Steps:**
1. Implement `run_bootstrap(storage_head, chain_tip)` that: requests `get_head`; if peer head > local, page `get_commitments_by_number` (respect `max_commitments_per_page`), validate and store; enqueue missing txlist hashes; fetch via `get_raw_txlist` with size/timeouts.
2. Emit `SdkEvent::HeadSyncStatus` updates; transition to Live once caught up; surface timeout/backoff policy.
3. Ensure bootstrap runs after sidecar signals L2 execution sync complete; allow restart on disconnect.

### Task 11: Gossip & req/resp handlers
**Files:** `crates/p2p/src/handlers.rs`

**Steps:**
1. Map `NetworkEvent` → internal handling: validate, dedupe, persist to storage, emit `SdkEvent` to subscribers. Apply scoring hints (penalize on invalid, reward on accept) via driver hooks if exposed.
2. Handle inbound requests using storage (`GetCommitmentsByNumberResponse`, `GetRawTxListResponse`, `PreconfHead`) with caps and rate limits; log oversized/invalid.

### Task 12: Publishing helpers
**Files:** `crates/p2p/src/sdk.rs` (or `publish.rs` helper)

**Steps:**
1. Wrap publish calls with local validation (so sidecar can fail fast); tag messages with message id for dedupe/self-ignore.
2. Provide convenience to publish commitment + optional txlist atomically (txlist first then commitment) to follow spec §6.1 ordering guidance.

### Task 13: Metrics & logging
**Files:** `crates/p2p/src/metrics.rs`, hook in sdk/handlers/catchup

**Steps:**
1. Define counters: `p2p_gossip_received_total{topic,outcome}`, `p2p_gossip_publish_total{topic,outcome}`, `p2p_reqresp_requests_total{protocol,outcome}`, `p2p_reqresp_latency_seconds`, `p2p_cache_hits_total{kind}`, `p2p_validation_failures_total{reason}`, `p2p_peer_score_gauge`.
2. Add tracing spans on per-message handling with peer/topic/hash; include dedupe and validation outcomes.

### Task 14: Unit tests
**Files:** `crates/p2p/src/{validation.rs,handlers.rs,cachup.rs,storage/memory.rs}` (inline `#[cfg(test)]` or `tests/`)

**Steps:**
1. Table-driven tests for validation (good sig, bad signer, wrong parent hash, oversize txlist, EOP handling).
2. Tests for dedupe/backpressure (bounded channels drop/reject), storage cache eviction obeying limits.
3. Catch-up tests with mocked `NetworkEvent` stream ensuring ordering + retry/backoff.

### Task 15: Integration smoke
**Files:** `crates/p2p/tests/integration_smoke.rs`

**Steps:**
1. Spin two `P2pSdk` instances with in-memory storage using preconfirmation-p2p service (loopback multiaddr); publish commitment+txlist from A, expect B receives gossip & stores; request head/commitments/raw_txlist between peers.
2. Run `cargo test -p p2p -- --nocapture integration_smoke` (expect PASS).

### Task 16: Docs & examples
**Files:** `crates/p2p/README.md`, rustdoc on `P2pSdk` and config

**Steps:**
1. Document lifecycle: call after L2 execution sync; bootstrap catch-up then subscribe; how to feed lookahead resolver; metrics names.
2. Provide minimal code snippet showing start, subscribe, publish, shutdown.

### Task 17: Verification
**Files:** N/A

**Steps:**
1. Run `just fmt` then `just clippy` (bindings excluded per repo rules).
2. Run `cargo test -p p2p` plus integration smoke; capture output for PR description.
3. Summarize follow-ups (persistent storage backend, metrics wiring to op stack) if deferred.

