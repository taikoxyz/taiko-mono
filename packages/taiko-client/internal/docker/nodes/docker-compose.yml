services:
  l1_node:
    container_name: l1_node
    image: ghcr.io/foundry-rs/foundry:stable
    restart: unless-stopped
    pull_policy: always
    ports:
      - "8545"
    entrypoint:
      - anvil
      - --chain-id
      - "32301"
      - --host
      - "0.0.0.0"
      - --hardfork
      - cancun

  postgresql:
    image: postgres:16
    shm_size: 1g
    restart: always
    volumes:
      - postgres_data:/var/lib/postgresql/data
    environment:
      POSTGRES_DB: protocol_indexer
      POSTGRES_PASSWORD: rindexer
    ports:
      - 5432:5432
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5

  protocol_indexer:
    container_name: protocol_indexer
    image: us-docker.pkg.dev/evmchain/images/protocol-indexer:shasta-indexer
    restart: unless-stopped
    pull_policy: always
    depends_on:
      - postgresql
    volumes:
      - .:/host
    environment:
      - RUN_MIGRATION=true
      - DATABASE_URL=postgresql://postgres:rindexer@postgresql:5432/protocol_indexer?sslmode=disable
      - LOCAL_RPC=http://l1_node:8545
    ports:
      - "3001"

  l2_geth:
    container_name: l2_geth
    image: us-docker.pkg.dev/evmchain/images/taiko-geth:shasta-fork
    restart: unless-stopped
    pull_policy: always
    volumes:
      - .:/host
    ports:
      - "8545"
      - "8546"
      - "8551"
    command:
      - --nodiscover
      - --gcmode
      - archive
      - --syncmode
      - full
      - --datadir
      - /data/taiko-geth
      - --networkid
      - "167001"
      - --metrics
      - --metrics.expensive
      - --metrics.addr
      - "0.0.0.0"
      - --http
      - --http.addr
      - "0.0.0.0"
      - --http.vhosts
      - "*"
      - --http.corsdomain
      - "*"
      - --ws
      - --ws.addr
      - "0.0.0.0"
      - --ws.origins
      - "*"
      - --authrpc.addr
      - "0.0.0.0"
      - --authrpc.port
      - "8551"
      - --authrpc.vhosts
      - "*"
      - --authrpc.jwtsecret
      - /host/jwt.hex
      - --allow-insecure-unlock
      - --http.api
      - admin,debug,eth,net,web3,txpool,miner,taiko
      - --ws.api
      - admin,debug,eth,net,web3,txpool,miner,taiko
      - --taiko

volumes:
  postgres_data:
